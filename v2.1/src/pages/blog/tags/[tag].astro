---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import BlogCard from "../../../components/BlogCard.astro";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";
import { getCollection } from "astro:content";
import marketing from "../../../data/site-data.json";
const { breadcrumbs } = marketing.site.components;
const baseUrl = marketing.site.organization.url;

export async function getStaticPaths() {
  const toSlug = (tag) => tag.toLowerCase().replace(/\s+/g, "-");
  const posts = await getCollection("blog");
  const tagMap = new Map();

  posts.forEach((post) => {
    post.data.tags.forEach((tag) => {
      const slug = toSlug(tag);
      if (!tagMap.has(slug)) {
        tagMap.set(slug, { tag, posts: [] });
      }
      tagMap.get(slug).posts.push(post);
    });
  });

  return Array.from(tagMap.entries()).map(([slug, data]) => ({
    params: { tag: slug },
    props: { tag: data.tag, posts: data.posts }
  }));
}

const { blogTag } = marketing.site.pages;
const toSlug = (tag) => tag.toLowerCase().replace(/\s+/g, "-");
const { tag, posts } = Astro.props;
const cards = posts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .map((post) => ({
    title: post.data.title,
    excerpt: post.data.excerpt,
    date: post.data.date.toLocaleDateString("en-US", {
      year: "numeric",
      month: "short",
      day: "2-digit"
    }),
    tags: post.data.tags,
    href: `/blog/${post.slug}`
  }));

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: breadcrumbs.home, item: baseUrl },
    { "@type": "ListItem", position: 2, name: breadcrumbs.tags, item: `${baseUrl}/blog/tags` },
    { "@type": "ListItem", position: 3, name: tag, item: `${baseUrl}/blog/tags/${toSlug(tag)}` }
  ]
};
---

<BaseLayout
  title={marketing.site.meta.blogTag.titleTemplate.replace("{tag}", tag)}
  description={marketing.site.meta.blogTag.descriptionTemplate.replace("{tag}", tag)}
  canonical={`${marketing.site.meta.blogTag.canonicalBase}/${toSlug(tag)}`}
  jsonLd={breadcrumbJsonLd}
>
  <section class="py-16">
    <div class="section-shell">
      <Breadcrumbs items={[
        { label: breadcrumbs.home, href: "/" },
        { label: breadcrumbs.tags, href: "/blog/tags" },
        { label: tag, href: `/blog/tags/${toSlug(tag)}` }
      ]} />
      <h1 class="mt-6 text-4xl font-semibold text-base-content">{tag}</h1>
      <p class="mt-4 max-w-2xl text-lg text-base-content/70">
        {blogTag.body.replace("{tag}", tag)}
      </p>
      <div class="mt-10 grid gap-6 md:grid-cols-2 xl:grid-cols-3">
        {cards.map((post) => (
          <BlogCard {...post} />
        ))}
      </div>
    </div>
  </section>
</BaseLayout>
